<?php

namespace App\Validator\Constraints\Evenement;

use App\Entity\Evenement;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Component\Validator\Constraint;
use Symfony\Component\Validator\ConstraintValidator;
use Symfony\Component\Validator\Validator\ValidatorInterface;

class EntityValidator extends ConstraintValidator
{
    private EntityManagerInterface $entityManager;
    private ValidatorInterface $validator;

    public function __construct(EntityManagerInterface $entityManager, ValidatorInterface $validator)
    {
        $this->entityManager = $entityManager;
        $this->validator = $validator;
    }

    /**
     * @param Evenement $entity
     *
     * @throws \Exception
     */
    public function validate($entity, Constraint $constraint)
    {
        //        throw new \Exception(__METHOD__);
        if (null === $entity || '' === $entity) {
            return;
        }

        if (!$entity->getDate() instanceof \DateTime) {
            $entity->setDate(new \DateTime($entity->getDate()));
        }

        $nowMinus12HoursUtc = (new \DateTime('now', new \DateTimeZone('UTC')))->modify('-12 hours -5 minutes');

        if ((null === $entity->getId()) && $entity->getDateToUtcTimezone() < $nowMinus12HoursUtc) {

            $this->context->buildViolation($constraint->messageRappelBeforeNow)
                ->atPath('date')
                ->addViolation();

            return;
        }

        $currentDate = $entity->getDate();

        $originalRappel = $this->entityManager
            ->getUnitOfWork()
            ->getOriginalEntityData($entity);

        if (null !== $originalRappel && !empty($originalRappel['date']) && $originalRappel['date'] !== $currentDate && $originalRappel['date'] < $nowMinus12HoursUtc) {
            $this->context->buildViolation($constraint->messageRappelBeforeNow)
                ->atPath('date')
                ->addViolation();

            return;
        }

        foreach ($entity->getRappels() as $rappel) {
            if ($rappel->getDate() > $entity->getDate()) {
                $this->context->addViolation($constraint->messageRappelAfterDateEvent);

                return;
            }
        }
    }
}
